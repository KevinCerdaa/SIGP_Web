<!DOCTYPE html>
<html lang="es-mx">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGP - INICIO</title>
    <link rel="stylesheet" href="frontend/styles/output.css">
    <style>
        /* Eliminar fondo blanco de los InfoWindows de Google Maps */
        .gm-style-iw {
            background: transparent !important;
            padding: 0 !important;
        }
        
        .gm-style-iw-d {
            background: transparent !important;
            padding: 0 !important;
            overflow: visible !important;
        }
        
        .gm-style-iw-c {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
        }
        
        /* Eliminar el bot贸n de cerrar blanco si es necesario */
        .gm-ui-hover-effect {
            opacity: 0.8;
        }
        
        .gm-ui-hover-effect:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-950 flex flex-col min-h-screen">
    <div id="header-container" class="w-full"></div>
    <main class="w-full h-auto py-4 sm:py-6 md:py-10 flex-1">
        <div class="w-full h-full flex flex-col items-center justify-center">
            <!-- Vista para usuarios NO autenticados: mapa completo sin filtros -->
            <div id="map-container-public" class="w-full px-4 sm:px-6 md:w-4/5 h-full flex flex-col items-center justify-center">
                <div id="map" class="rounded-lg md:rounded-2xl w-full h-[300px] sm:h-[400px] md:h-[500px] lg:h-[600px] border border-slate-600"></div>
            </div>
            
            <!-- Vista para usuarios autenticados: mapa flex-1 + filtros flex-1 -->
            <div id="map-container-authenticated" class="w-full px-4 sm:px-6 md:w-4/5 flex flex-col md:flex-row items-start md:items-center justify-center gap-4 min-h-[500px] md:h-[600px] md:min-h-[600px] hidden">
                <!-- Mapa flex-1 -->
                <div class="w-full md:w-3/5 flex flex-col items-center justify-center min-h-[300px] sm:min-h-[400px] md:h-full md:min-h-[600px]">
                    <div id="map-authenticated" class="rounded-lg md:rounded-2xl w-full h-[300px] sm:h-[400px] md:h-full md:min-h-[600px] border border-slate-600"></div>
                </div>
                
                <!-- Filtros flex-1 -->
                <div class="w-full md:w-2/5 h-auto md:h-full md:min-h-[600px] flex flex-col items-start justify-center md:justify-center gap-3 py-4 md:py-6">
                    <!-- Selector de Zona -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="zona-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Zona:</label>
                        <div class="relative w-full">
                            <select id="zona-select" name="zona" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" disabled selected>Selecciona zona</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Grado de Peligrosidad -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="peligrosidad-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Grado de peligrosidad:</label>
                        <div class="relative w-full">
                            <select id="peligrosidad-select" name="peligrosidad" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" disabled selected>Selecciona la peligrosidad</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Delito -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="delito-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Delito:</label>
                        <div class="relative w-full">
                            <select id="delito-select" name="delito" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" selected>Ninguno</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot贸n Activar mapa de calor -->
                    <div class="w-full h-auto flex flex-col items-center justify-center mt-2 gap-3">
                        <button type="button" id="heatmap-btn" class="w-full h-[45px] md:h-[50px] rounded-lg bg-blue-400 text-white text-base md:text-lg font-medium flex items-center justify-center hover:bg-blue-600 transition-all duration-150 hover:cursor-pointer">Activar mapa de calor</button>
                        <!-- Checkbox para ocultar pines (solo visible cuando el mapa de calor est谩 activo) -->
                        <div id="hide-markers-container" class="hidden w-full h-auto flex items-center justify-start gap-2 px-2">
                            <input type="checkbox" id="hide-markers-checkbox" class="w-5 h-5 rounded border-slate-400 text-blue-600 focus:ring-blue-500 focus:ring-2 cursor-pointer">
                            <label for="hide-markers-checkbox" class="text-sm md:text-base text-white opacity-70 cursor-pointer select-none">Ocultar pines</label>
                        </div>
                    </div>
                </div>
            </div>
    </main>
    <div id="footer-container"></div>
    <div id="modal-container"></div>
    <script src="frontend/javascript/app.js"></script>
    <script src="frontend/javascript/auth.js"></script>
    <script src="frontend/javascript/modals.js"></script>
    <script src="frontend/javascript/nuevo_usuario.js"></script>
    <script>
        let map;
        let mapAuthenticated;
        let currentInfoWindow = null;
        let allMarkers = [];
        let currentMarkers = [];
        let zonePolygons = {};
        let currentZonePolygon = null;
        let heatmapLayer = null;
        let heatmapActive = false;
        
        // Estilo personalizado para tema oscuro del mapa
        const darkMapStyle = [
            { elementType: 'geometry', stylers: [{ color: '#1e293b' }] },
            { elementType: 'labels.text.stroke', stylers: [{ color: '#0f172a' }] },
            { elementType: 'labels.text.fill', stylers: [{ color: '#cbd5e1' }] },
            {
                featureType: 'administrative',
                elementType: 'geometry.stroke',
                stylers: [{ color: '#334155' }]
            },
            {
                featureType: 'administrative.land_parcel',
                elementType: 'geometry.stroke',
                stylers: [{ color: '#334155' }]
            },
            {
                featureType: 'administrative.land_parcel',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#94a3b8' }]
            },
            {
                featureType: 'landscape.natural',
                elementType: 'geometry',
                stylers: [{ color: '#1e293b' }]
            },
            {
                featureType: 'poi',
                elementType: 'geometry',
                stylers: [{ color: '#1e293b' }]
            },
            {
                featureType: 'poi',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#94a3b8' }]
            },
            {
                featureType: 'poi',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#0f172a' }]
            },
            {
                featureType: 'poi.park',
                elementType: 'geometry.fill',
                stylers: [{ color: '#0f172a' }]
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#64748b' }]
            },
            {
                featureType: 'road',
                elementType: 'geometry',
                stylers: [{ color: '#334155' }]
            },
            {
                featureType: 'road',
                elementType: 'geometry.stroke',
                stylers: [{ color: '#475569' }]
            },
            {
                featureType: 'road',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#cbd5e1' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry',
                stylers: [{ color: '#475569' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry.stroke',
                stylers: [{ color: '#64748b' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#e2e8f0' }]
            },
            {
                featureType: 'road.arterial',
                elementType: 'geometry',
                stylers: [{ color: '#334155' }]
            },
            {
                featureType: 'road.local',
                elementType: 'geometry',
                stylers: [{ color: '#1e293b' }]
            },
            {
                featureType: 'transit',
                elementType: 'geometry',
                stylers: [{ color: '#1e293b' }]
            },
            {
                featureType: 'transit.station',
                elementType: 'geometry',
                stylers: [{ color: '#334155' }]
            },
            {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{ color: '#0f172a' }]
            },
            {
                featureType: 'water',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#64748b' }]
            },
            {
                featureType: 'water',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#0f172a' }]
            }
        ];
        
        // Coordenadas detalladas de las zonas de San Luis Potos铆
        // Basadas en la plantilla mejorada (plantilla3.html)
        // IMPORTANTE:
        // Los IDs deben coincidir con los de la tabla "zonas" del backend:
        //  1: Norte
        //  2: Sur
        //  3: Oriente
        //  4: Poniente
        //  5: Centro
        const zoneCoordinates = {
            1: { // Norte
                name: "Norte",
                // Color tomado de la plantilla mejorada (id 2 - Norte)
                color: "#00AAFF",
                path: [
                    { lat: 22.1980806, lng: -101.0191069 },
                    { lat: 22.2044778, lng: -101.0160550 },
                    { lat: 22.2185265, lng: -100.9724515 },
                    { lat: 22.2131050, lng: -100.9327801 },
                    { lat: 22.2054055, lng: -100.9222381 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1712311, lng: -100.9672749 },
                    { lat: 22.1732495, lng: -100.9708684 },
                    { lat: 22.170000, lng: -101.001667 }
                ]
            },
            2: { // Sur
                name: "Sur",
                // Color tomado de la plantilla (id 3 - Sur)
                color: "#FF9900",
                path: [
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1281250, lng: -100.9758834 },
                    { lat: 22.1390283, lng: -101.0016146 },
                    { lat: 22.1259710, lng: -101.0171827 },
                    { lat: 22.1155634, lng: -100.9999287 },
                    { lat: 22.1170518, lng: -100.9969650 },
                    { lat: 22.1152539, lng: -100.9858002 },
                    { lat: 22.1009685, lng: -100.9524824 }
                ]
            },
            3: { // Oriente / Este
                name: "Oriente",
                // Color tomado de la plantilla (id 4 - Oriente / Este)
                color: "#00CC00",
                path: [
                    { lat: 22.2054055, lng: -100.9222381 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1009685, lng: -100.9524824 },
                    { lat: 22.1152030, lng: -100.9263403 },
                    { lat: 22.1258643, lng: -100.9192584 },
                    { lat: 22.1543387, lng: -100.9143996 }
                ]
            },
            4: { // Poniente / Oeste
                name: "Poniente",
                // Color tomado de la plantilla (id 5 - Poniente / Oeste)
                color: "#AA00FF",
                path: [
                    { lat: 22.1980806, lng: -101.0191069 },
                    { lat: 22.170000, lng: -101.001667 },
                    { lat: 22.1390283, lng: -101.0016146 },
                    { lat: 22.1259710, lng: -101.0171827 },
                    { lat: 22.1322477, lng: -101.0338589 },
                    { lat: 22.1515664, lng: -101.0337646 },
                    { lat: 22.1721585, lng: -101.0400926 },
                    { lat: 22.1862328, lng: -101.0328764 }
                ]
            },
            5: { // Centro (Casco Hist贸rico)
                name: "Centro",
                // Color tomado de la plantilla (id 1 - Centro)
                color: "#FF0000",
                path: [
                    { lat: 22.170000, lng: -101.001667 },
                    { lat: 22.1732495, lng: -100.9708684 },
                    { lat: 22.1712311, lng: -100.9672749 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1281250, lng: -100.9758834 },
                    { lat: 22.1390283, lng: -101.0016146 }
                ]
            },
        };

        // Funci贸n para cargar zonas en el selector
        async function loadZones() {
            try {
                const response = await fetch("http://localhost:8000/api/zones/");
                if (!response.ok) throw new Error("Error al cargar zonas");
                const zones = await response.json();
                
                const zonaSelect = document.getElementById("zona-select");
                if (!zonaSelect) return;
                
                // Limpiar opciones existentes
                zonaSelect.innerHTML = '';
                
                // Agregar opci贸n "Todas las zonas"
                const allOption = document.createElement("option");
                allOption.value = "";
                allOption.textContent = "Todas las zonas";
                allOption.selected = true;
                zonaSelect.appendChild(allOption);
                
                // Agregar zonas
                zones.forEach(zone => {
                    const option = document.createElement("option");
                    option.value = zone.id;
                    option.textContent = zone.nombre;
                    zonaSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar zonas:", error);
            }
        }

        // Funci贸n para cargar delitos en el selector
        async function loadCrimes() {
            try {
                const response = await fetch("http://localhost:8000/api/crimes/");
                if (!response.ok) throw new Error("Error al cargar delitos");
                const crimes = await response.json();
                
                const delitoSelect = document.getElementById("delito-select");
                if (!delitoSelect) return;
                
                // Limpiar opciones existentes
                delitoSelect.innerHTML = '';
                
                // Agregar opci贸n "Ninguno" para deseleccionar
                const noneOption = document.createElement("option");
                noneOption.value = "";
                noneOption.textContent = "Ninguno";
                noneOption.selected = true;
                delitoSelect.appendChild(noneOption);
                
                // Agregar delitos
                crimes.forEach(crime => {
                    const option = document.createElement("option");
                    option.value = crime.id;
                    option.textContent = crime.nombre;
                    delitoSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar delitos:", error);
            }
        }

        // Funci贸n para cargar niveles de peligrosidad en el selector
        function loadPeligrosidad() {
            // Solo 3 niveles: Bajo, Medio, Alto (strings)
            const peligrosidadLevels = [
                { nombre: 'Bajo', valor: 'Bajo' },
                { nombre: 'Medio', valor: 'Medio' },
                { nombre: 'Alto', valor: 'Alto' }
            ];
            
            const peligrosidadSelect = document.getElementById("peligrosidad-select");
            if (!peligrosidadSelect) return;
            
            // Limpiar opciones existentes
            peligrosidadSelect.innerHTML = '<option value="" disabled selected>Selecciona la peligrosidad</option>';
            
            // Agregar opci贸n "Todas"
            const todasOption = document.createElement("option");
            todasOption.value = "";
            todasOption.textContent = "Todas";
            peligrosidadSelect.appendChild(todasOption);
            
            // Agregar niveles de peligrosidad
            peligrosidadLevels.forEach(level => {
                const option = document.createElement("option");
                option.value = level.valor; // Usar el string: "Bajo", "Medio", "Alto"
                option.textContent = level.nombre;
                peligrosidadSelect.appendChild(option);
            });
        }

        // Funci贸n para dibujar pol铆gono de zona y hacer zoom a la zona seleccionada
        function drawZonePolygon(mapInstance, zoneId) {
            // Eliminar pol铆gono anterior si existe
            if (currentZonePolygon) {
                currentZonePolygon.setMap(null);
                currentZonePolygon = null;
            }
            
            // Si no hay zona seleccionada ("Todas las zonas"), limpiar pol铆gono
            // y restablecer el zoom/centro iniciales
            if (!zoneId || zoneId === '') {
                if (mapInstance) {
                    mapInstance.setCenter({ lat: 22.152089, lng: -100.973302 });
                    mapInstance.setZoom(12);
                }
                return;
            }
            
            const zone = zoneCoordinates[parseInt(zoneId)];
            if (!zone) return;
            
            // Crear pol铆gono para la zona
            currentZonePolygon = new google.maps.Polygon({
                paths: zone.path,
                strokeColor: zone.color || '#3B82F6',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: zone.color || '#3B82F6',
                fillOpacity: 0.2
            });
            
            currentZonePolygon.setMap(mapInstance);

            // Calcular bounds para la zona y ajustar el zoom
            const bounds = new google.maps.LatLngBounds();
            zone.path.forEach(coord => bounds.extend(coord));
            mapInstance.fitBounds(bounds);

            // Limitar el zoom m谩ximo para que no se acerque demasiado
            google.maps.event.addListenerOnce(mapInstance, 'bounds_changed', function () {
                if (mapInstance.getZoom() > 14) {
                    mapInstance.setZoom(14);
                }
            });
        }
        
        // Funci贸n global para recargar marcadores (disponible desde otros scripts)
        window.reloadMapMarkers = function() {
            console.log(' Recargando marcadores del mapa...');
            if (mapAuthenticated) {
                console.log('Recargando mapa autenticado...');
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                const delitoSelect = document.getElementById("delito-select");
                
                const selectedZona = zonaSelect && zonaSelect.value ? zonaSelect.value : null;
                const selectedPeligrosidad = peligrosidadSelect && peligrosidadSelect.value ? peligrosidadSelect.value : null;
                const selectedDelito = delitoSelect && delitoSelect.value ? delitoSelect.value : null;
                
                loadMarkers(mapAuthenticated, selectedZona, selectedPeligrosidad, selectedDelito);
            }
            if (map) {
                console.log('Recargando mapa p煤blico...');
                // Ciudadanos ven todos los pines sin filtros
                loadMarkers(map, null, null, null);
            }
        };
        
        // Funci贸n para cargar marcadores en el mapa
        function loadMarkers(mapInstance, filterZona = null, filterPeligrosidad = null, filterDelito = null) {
            // Limpiar marcadores anteriores
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            // Si el heatmap est谩 activo, actualizarlo
            if (heatmapActive && heatmapLayer) {
                heatmapLayer.setMap(null);
                heatmapLayer = null;
                heatmapActive = false;
                const heatmapBtn = document.getElementById("heatmap-btn");
                if (heatmapBtn) {
                    heatmapBtn.textContent = "Activar mapa de calor";
                    heatmapBtn.classList.remove("bg-red-400", "hover:bg-red-600");
                    heatmapBtn.classList.add("bg-blue-400", "hover:bg-blue-600");
                }
            }
            
            // Dibujar pol铆gono de la zona seleccionada
            drawZonePolygon(mapInstance, filterZona);
            
            fetch("http://localhost:8000/api/addresses/")
                .then(r => {
                    if (!r.ok) throw new Error("Error en la respuesta del servidor");
                    return r.json();
                })
                .then(data => {
                    const bounds = new google.maps.LatLngBounds();
                    let hasMarkers = false;

                    data.forEach(item => {
                        // Filtrar por zona si se especifica
                        if (filterZona !== null && filterZona !== '' && item.id_zona !== parseInt(filterZona)) {
                            return;
                        }
                        
                        // Filtrar por peligrosidad si se especifica
                        if (filterPeligrosidad !== null && filterPeligrosidad !== '') {
                            const itemPeligro = (item.grado_peligro || '').toString().trim();
                            if (itemPeligro.toLowerCase() !== filterPeligrosidad.toLowerCase()) {
                                return;
                            }
                        }
                        
                        // Filtrar por delito si se especifica (solo para eventos)
                        if (filterDelito !== null && filterDelito !== '') {
                            if (item.tipo === 'evento' && item.id_delito !== parseInt(filterDelito)) {
                                return;
                            } else if (item.tipo === 'pandilla') {
                                // Para pandillas, necesitar铆amos verificar si tienen ese delito asociado
                                // Por ahora, si se filtra por delito, solo mostramos eventos
                                return;
                            }
                        }
                        
                        if (item.lat && item.lng) {
                            const position = {
                                lat: parseFloat(item.lat),
                                lng: parseFloat(item.lng)
                            };

                            // Determinar color del marcador seg煤n peligrosidad
                            const peligro = (item.grado_peligro || 'Alto').toString().trim();
                            let markerColor = '#EF4444'; // Rojo por defecto
                            let markerBorder = '#DC2626';
                            if (peligro.toLowerCase() === 'bajo') {
                                markerColor = '#22C55E'; // Verde - Bajo
                                markerBorder = '#16A34A';
                            } else if (peligro.toLowerCase() === 'medio') {
                                markerColor = '#EAB308'; // Amarillo - Medio
                                markerBorder = '#CA8A04';
                            } else if (peligro.toLowerCase() === 'alto') {
                                markerColor = '#EF4444'; // Rojo - Alto
                                markerBorder = '#DC2626';
                            }

                            // Crear icono SVG personalizado
                            const filterId = `shadow-${item.id_pandilla || item.id_evento || item.id || Math.random().toString(36).substr(2, 9)}`;
                            const iconSvg = `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg" style="background:transparent;"><defs><filter id="${filterId}" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/></filter></defs><path d="M16 0C7.163 0 0 7.163 0 16c0 10 16 24 16 24s16-14 16-24C32 7.163 24.837 0 16 0z" fill="${markerColor}" stroke="${markerBorder}" stroke-width="1.5" filter="url(#${filterId})"/><circle cx="16" cy="16" r="5" fill="#FFFFFF" opacity="0.95"/></svg>`;
                            
                            const iconUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(iconSvg)));

                            const marker = new google.maps.Marker({
                                position,
                                map: mapInstance,
                                title: item.nombre_pandilla || item.nombre || "Ubicaci贸n",
                                icon: {
                                    url: iconUrl,
                                    scaledSize: new google.maps.Size(32, 40),
                                    anchor: new google.maps.Point(16, 40),
                                    optimized: false
                                },
                                optimized: false
                            });

                            // Guardar informaci贸n adicional en el marcador para el heatmap
                            let pesoHeatmap = 1;
                            if (peligro.toLowerCase() === 'bajo') {
                                pesoHeatmap = 1;
                            } else if (peligro.toLowerCase() === 'medio') {
                                pesoHeatmap = 2;
                            } else if (peligro.toLowerCase() === 'alto') {
                                pesoHeatmap = 3;
                            }
                            marker.peligrosidad = pesoHeatmap;
                            marker.itemData = item; // Guardar datos del item para el InfoWindow

                            // Determinar qu茅 informaci贸n mostrar seg煤n el rol del usuario
                            // Verificar si getUserRol est谩 disponible (se carga desde auth.js)
                            let userRol = null;
                            try {
                                if (typeof getUserRol === 'function') {
                                    userRol = getUserRol();
                                } else if (typeof localStorage !== 'undefined') {
                                    userRol = localStorage.getItem('user_rol');
                                }
                            } catch (e) {
                                console.log('No se pudo obtener el rol del usuario:', e);
                            }
                            
                            const isAdminOrConsultor = userRol === 'admin' || userRol === 'consultor';
                            const nombrePandilla = item.nombre_pandilla || item.nombre || 'Ubicaci贸n sin nombre';
                            
                            let infoContent = '';
                            
                            if (isAdminOrConsultor) {
                                // InfoWindow completo para admin/consultor
                                const gradoPeligro = (item.grado_peligro || 'Alto').toString().trim();
                                const calle = item.calle || '';
                                const numero = item.numero || '';
                                const colonia = item.colonia || '';
                                const direccionCompleta = [calle, numero, colonia].filter(Boolean).join(', ') || 'Direcci贸n no disponible';
                                
                                // Determinar color del badge seg煤n peligrosidad
                                let peligroColor = '#EF4444'; // Rojo - Alto
                                let peligroTexto = 'Alto';
                                if (gradoPeligro.toLowerCase() === 'bajo') {
                                    peligroColor = '#22C55E'; // Verde
                                    peligroTexto = 'Bajo';
                                } else if (gradoPeligro.toLowerCase() === 'medio') {
                                    peligroColor = '#EAB308'; // Amarillo
                                    peligroTexto = 'Medio';
                                }
                                
                                // Obtener nombre de zona si est谩 disponible
                                let zonaTexto = '';
                                if (item.id_zona) {
                                    // Intentar obtener el nombre de la zona desde el objeto zoneCoordinates
                                    const zonaId = parseInt(item.id_zona);
                                    if (zoneCoordinates[zonaId]) {
                                        zonaTexto = zoneCoordinates[zonaId].name;
                                    } else {
                                        zonaTexto = `Zona ${item.id_zona}`;
                                    }
                                }
                                
                                infoContent = `
                                    <div style="padding: 1rem; font-family: system-ui, -apple-system, sans-serif; min-width: 250px; max-width: 350px;">
                                        <div style="background: rgba(30, 41, 59, 0.95); border-radius: 0.5rem; border: 1px solid rgb(51, 65, 85);">
                                            <div style="padding: 1rem;">
                                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #FFFFFF; margin: 0 0 0.75rem 0; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 0.5rem;">
                                                    ${nombrePandilla}
                                                </h3>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <span style="font-weight: 600; color: #CBD5E1; font-size: 0.875rem;">Peligrosidad:</span>
                                                        <span style="background: ${peligroColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                                            ${peligroTexto}
                                                        </span>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                                        <span style="font-weight: 600; color: #CBD5E1; font-size: 0.875rem;">Direcci贸n:</span>
                                                        <span style="color: #94A3B8; font-size: 0.875rem; line-height: 1.4;">
                                                            ${direccionCompleta}
                                                        </span>
                                                    </div>
                                                    ${zonaTexto ? `
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <span style="font-weight: 600; color: #CBD5E1; font-size: 0.875rem;">Zona:</span>
                                                        <span style="color: #94A3B8; font-size: 0.875rem;">
                                                            ${zonaTexto}
                                                        </span>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // InfoWindow simplificado para ciudadanos: solo nombre
                                infoContent = `
                                    <div style="padding: 1rem; font-family: system-ui, -apple-system, sans-serif;">
                                        <div style="background: rgba(30, 41, 59, 0.95); border-radius: 0.5rem; border: 1px solid rgb(51, 65, 85);">
                                            <div style="padding: 0.75rem;">
                                                <h3 style="font-size: 1rem; font-weight: 700; color: #FFFFFF; margin: 0;">
                                                    ${nombrePandilla}
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }

                            const infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });

                            marker.addListener("click", () => {
                                if (currentInfoWindow) {
                                    currentInfoWindow.close();
                                }
                                infoWindow.open(mapInstance, marker);
                                currentInfoWindow = infoWindow;
                            });

                            currentMarkers.push(marker);
                            bounds.extend(position);
                            hasMarkers = true;
                        }
                    });

                    if (hasMarkers) {
                        if (currentMarkers.length === 1) {
                            mapInstance.setCenter(bounds.getCenter());
                            mapInstance.setZoom(14);
                        } else {
                            mapInstance.fitBounds(bounds);
                        }
                        console.log(`Marcadores cargados: ${currentMarkers.length}${filterZona ? ` (Zona: ${filterZona})` : ''}${filterPeligrosidad ? ` (Peligrosidad: ${filterPeligrosidad})` : ''}${filterDelito ? ` (Delito: ${filterDelito})` : ''}`);
                    } else {
                        mapInstance.setCenter({ lat: 22.152089, lng: -100.973302 });
                        mapInstance.setZoom(12);
                        console.log('No se encontraron marcadores para los filtros seleccionados');
                    }
                })
                .catch(err => console.error("Error al cargar marcadores:", err));
        }

        // Funci贸n para activar/desactivar mapa de calor
        function toggleHeatmap() {
            const mapInstance = mapAuthenticated || map;
            if (!mapInstance) {
                console.error('Mapa no est谩 inicializado');
                return;
            }

            const heatmapBtn = document.getElementById("heatmap-btn");
            if (!heatmapBtn) return;

            if (!heatmapActive) {
                // Activar mapa de calor
                // Obtener todos los puntos de los marcadores actuales
                const heatmapData = [];
                
                currentMarkers.forEach(marker => {
                    // Obtener el grado de peligro del marcador si est谩 disponible
                    const peligro = marker.peligrosidad || 1;
                    // Usar el peso basado en peligrosidad: Bajo (1) = 1, Medio (2) = 2, Alto (3) = 3
                    heatmapData.push({
                        location: marker.getPosition(),
                        weight: peligro
                    });
                });

                // Si no hay marcadores, cargar todos los datos
                if (heatmapData.length === 0) {
                    fetch("http://localhost:8000/api/addresses/")
                        .then(r => {
                            if (!r.ok) throw new Error("Error al cargar datos para heatmap");
                            return r.json();
                        })
                        .then(data => {
                            data.forEach(item => {
                                if (item.lat && item.lng) {
                                    // Usar el peso basado en peligrosidad: Bajo (1) = 1, Medio (2) = 2, Alto (3) = 3
                                    const peligro = parseInt(item.grado_peligro) || 1;
                                    heatmapData.push({
                                        location: new google.maps.LatLng(
                                            parseFloat(item.lat),
                                            parseFloat(item.lng)
                                        ),
                                        weight: peligro
                                    });
                                }
                            });
                            createHeatmap(heatmapData);
                        })
                        .catch(err => console.error("Error al cargar datos para heatmap:", err));
                } else {
                    createHeatmap(heatmapData);
                }
            } else {
                // Desactivar mapa de calor
                if (heatmapLayer) {
                    heatmapLayer.setMap(null);
                    heatmapLayer = null;
                }
                heatmapActive = false;
                heatmapBtn.textContent = "Activar mapa de calor";
                heatmapBtn.classList.remove("bg-red-400", "hover:bg-red-600");
                heatmapBtn.classList.add("bg-blue-400", "hover:bg-blue-600");
                
                // Ocultar checkbox y mostrar todos los marcadores
                const hideMarkersContainer = document.getElementById("hide-markers-container");
                const hideMarkersCheckbox = document.getElementById("hide-markers-checkbox");
                if (hideMarkersContainer) {
                    hideMarkersContainer.classList.add("hidden");
                }
                if (hideMarkersCheckbox) {
                    hideMarkersCheckbox.checked = false;
                }
                // Asegurar que todos los marcadores est茅n visibles
                currentMarkers.forEach(marker => {
                    marker.setVisible(true);
                });
            }
        }

        // Funci贸n para crear el mapa de calor
        function createHeatmap(heatmapData) {
            const mapInstance = mapAuthenticated || map;
            if (!mapInstance || !google.maps.visualization) {
                console.error('Google Maps Visualization library no est谩 disponible');
                return;
            }

            // Eliminar heatmap anterior si existe
            if (heatmapLayer) {
                heatmapLayer.setMap(null);
            }

            // Crear nuevo heatmap con gradiente seg煤n requerimientos: Amarillabaja, Naranjamedia, Rojaalta
            heatmapLayer = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: mapAuthenticated || map,
                radius: 50,
                opacity: 0.6,
                gradient: [
                    'rgba(255, 255, 0, 0)',      // Amarilla transparente (Baja)
                    'rgba(255, 255, 0, 0.3)',   // Amarilla suave
                    'rgba(255, 255, 0, 0.6)',   // Amarilla media
                    'rgba(255, 165, 0, 0.7)',   // Naranja (Media)
                    'rgba(255, 165, 0, 0.9)',   // Naranja intenso
                    'rgba(255, 0, 0, 1)'        // Roja (Alta)
                ]
            });

            heatmapActive = true;
            const heatmapBtn = document.getElementById("heatmap-btn");
            if (heatmapBtn) {
                heatmapBtn.textContent = "Desactivar mapa de calor";
                heatmapBtn.classList.remove("bg-blue-400", "hover:bg-blue-600");
                heatmapBtn.classList.add("bg-red-400", "hover:bg-red-600");
            }
            
            // Mostrar checkbox para ocultar pines
            const hideMarkersContainer = document.getElementById("hide-markers-container");
            if (hideMarkersContainer) {
                hideMarkersContainer.classList.remove("hidden");
            }
        }
        
        // Funci贸n para ocultar/mostrar marcadores
        function toggleMarkersVisibility() {
            const hideMarkersCheckbox = document.getElementById("hide-markers-checkbox");
            if (!hideMarkersCheckbox) return;
            
            const shouldHide = hideMarkersCheckbox.checked;
            
            currentMarkers.forEach(marker => {
                marker.setVisible(!shouldHide);
            });
        }

        // Funci贸n para verificar si un elemento est谩 visible
        function isElementVisible(element) {
            if (!element) return false;
            const style = window.getComputedStyle(element);
            return style.display !== 'none' && style.visibility !== 'hidden' && !element.classList.contains('hidden');
        }

        // Funci贸n para inicializar mapa p煤blico
        function initPublicMap() {
            const mapElement = document.getElementById("map");
            if (!mapElement) return false;
            
            // Si ya est谩 inicializado, solo hacer resize
            if (map) {
                setTimeout(() => {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter({ lat: 22.152089, lng: -100.973302 });
                }, 100);
                return true;
            }
            
            // Verificar que el elemento est茅 visible
            if (!isElementVisible(mapElement.closest('#map-container-public'))) {
                console.log('Mapa p煤blico no visible a煤n, esperando...');
                return false;
            }
            
            map = new google.maps.Map(mapElement, {
                center: { lat: 22.152089, lng: -100.973302 },
                zoom: 12,
                styles: darkMapStyle,
                mapTypeControl: false,
                fullscreenControl: true,
                streetViewControl: false,
                zoomControl: true
            });
            // Cargar todos los marcadores sin filtros para ciudadanos
            loadMarkers(map, null, null, null);
            
            // Forzar resize despu茅s de un momento (m煤ltiples veces para asegurar renderizado)
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 100);
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 300);
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 500);
            
            return true;
        }

        // Funci贸n para inicializar mapa autenticado
        function initAuthenticatedMap() {
            const mapElement = document.getElementById("map-authenticated");
            if (!mapElement) return false;
            
            // Si ya est谩 inicializado, solo hacer resize
            if (mapAuthenticated) {
                setTimeout(() => {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                    mapAuthenticated.setCenter({ lat: 22.152089, lng: -100.973302 });
                }, 100);
                return true;
            }
            
            // Verificar que el elemento est茅 visible
            if (!isElementVisible(mapElement.closest('#map-container-authenticated'))) {
                console.log('Mapa autenticado no visible a煤n, esperando...');
                return false;
            }
            
            mapAuthenticated = new google.maps.Map(mapElement, {
                center: { lat: 22.152089, lng: -100.973302 },
                zoom: 12,
                styles: darkMapStyle,
                mapTypeControl: false,
                fullscreenControl: true,
                streetViewControl: false,
                zoomControl: true
            });
            loadMarkers(mapAuthenticated);
            
            // Cargar zonas, delitos y peligrosidad en los selectores
            loadZones();
            loadCrimes();
            loadPeligrosidad();
            
            // Agregar evento al bot贸n de mapa de calor
            setTimeout(() => {
                const heatmapBtn = document.getElementById("heatmap-btn");
                if (heatmapBtn) {
                    heatmapBtn.addEventListener("click", toggleHeatmap);
                }
                
                // Agregar evento al checkbox para ocultar/mostrar marcadores
                const hideMarkersCheckbox = document.getElementById("hide-markers-checkbox");
                if (hideMarkersCheckbox) {
                    hideMarkersCheckbox.addEventListener("change", toggleMarkersVisibility);
                }
            }, 500);
            
            // Funci贸n para manejar cambios en los filtros del mapa autenticado
            function handleAuthenticatedFiltersChange() {
                if (!mapAuthenticated) return;
                
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                const delitoSelect = document.getElementById("delito-select");
                
                const selectedZona = zonaSelect && zonaSelect.value ? zonaSelect.value : null;
                const selectedPeligrosidad = peligrosidadSelect && peligrosidadSelect.value ? peligrosidadSelect.value : null;
                const selectedDelito = delitoSelect && delitoSelect.value ? delitoSelect.value : null;
                
                console.log('Filtros seleccionados:', { zona: selectedZona, peligrosidad: selectedPeligrosidad, delito: selectedDelito });
                
                // Recargar marcadores con todos los filtros
                loadMarkers(mapAuthenticated, selectedZona, selectedPeligrosidad, selectedDelito);
            }
            
            // Esperar un momento para que los selectores se carguen y luego agregar los eventos
            setTimeout(() => {
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                const delitoSelect = document.getElementById("delito-select");
                
                if (zonaSelect) {
                    zonaSelect.addEventListener("change", handleAuthenticatedFiltersChange);
                }
                if (peligrosidadSelect) {
                    peligrosidadSelect.addEventListener("change", handleAuthenticatedFiltersChange);
                }
                if (delitoSelect) {
                    delitoSelect.addEventListener("change", handleAuthenticatedFiltersChange);
                }
            }, 500);
            
            // Forzar resize despu茅s de un momento (m煤ltiples veces para asegurar renderizado)
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 100);
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 300);
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 500);
            
            return true;
        }

        // Funci贸n para mostrar/ocultar vistas seg煤n autenticaci贸n (disponible globalmente)
        window.toggleMapView = function() {
            const isAuth = typeof isAuthenticated === 'function' ? isAuthenticated() : false;
            const publicContainer = document.getElementById("map-container-public");
            const authenticatedContainer = document.getElementById("map-container-authenticated");

            if (isAuth) {
                // Usuario autenticado: mostrar vista con filtros
                if (publicContainer) publicContainer.classList.add("hidden");
                if (authenticatedContainer) authenticatedContainer.classList.remove("hidden");
                
                // Inicializar mapa autenticado si Google Maps est谩 cargado
                if (typeof google !== 'undefined' && google.maps) {
                    // Esperar a que el contenedor sea visible y luego inicializar
                    const tryInit = () => {
                        if (initAuthenticatedMap()) {
                            console.log('Mapa autenticado inicializado correctamente');
                            // Forzar m煤ltiples resize para asegurar renderizado
                            setTimeout(() => {
                                if (mapAuthenticated) {
                                    google.maps.event.trigger(mapAuthenticated, 'resize');
                                }
                            }, 100);
                            setTimeout(() => {
                                if (mapAuthenticated) {
                                    google.maps.event.trigger(mapAuthenticated, 'resize');
                                }
                            }, 300);
                        } else {
                            // Reintentar despu茅s de un momento
                            setTimeout(tryInit, 200);
                        }
                    };
                    // Esperar un poco m谩s para asegurar que el contenedor es visible
                    setTimeout(tryInit, 300);
                }
            } else {
                // Usuario no autenticado: mostrar vista p煤blica
                if (publicContainer) publicContainer.classList.remove("hidden");
                if (authenticatedContainer) authenticatedContainer.classList.add("hidden");
                
                // Inicializar mapa p煤blico si Google Maps est谩 cargado
                if (typeof google !== 'undefined' && google.maps) {
                    // Esperar a que el contenedor sea visible y luego inicializar
                    const tryInit = () => {
                        if (initPublicMap()) {
                            console.log('Mapa p煤blico inicializado correctamente');
                            // Forzar m煤ltiples resize para asegurar renderizado
                            setTimeout(() => {
                                if (map) {
                                    google.maps.event.trigger(map, 'resize');
                                }
                            }, 100);
                            setTimeout(() => {
                                if (map) {
                                    google.maps.event.trigger(map, 'resize');
                                }
                            }, 300);
                        } else {
                            // Reintentar despu茅s de un momento
                            setTimeout(tryInit, 200);
                        }
                    };
                    setTimeout(tryInit, 100);
                }
            }
        }

        // Funci贸n principal de inicializaci贸n (callback de Google Maps)
        function initMap() {
            // Esperar a que el DOM est茅 completamente listo
            setTimeout(() => {
                // Verificar autenticaci贸n y mostrar la vista correcta
                toggleMapView();
            }, 300);
        }

        // Verificar autenticaci贸n cuando se carga la p谩gina
        document.addEventListener('DOMContentLoaded', function() {
            // Si Google Maps ya est谩 cargado, inicializar
            if (typeof google !== 'undefined' && google.maps) {
                // Si no hay mapa p煤blico, inicializarlo
                if (!map) {
                    initPublicMap();
                }
                // Luego verificar autenticaci贸n
                toggleMapView();
            }
        });

        // Tambi茅n verificar despu茅s de que se carguen los scripts de auth
        setTimeout(() => {
            if (typeof google !== 'undefined' && google.maps) {
                // Si no hay mapa p煤blico, inicializarlo
                if (!map) {
                    initPublicMap();
                }
                // Luego verificar autenticaci贸n
                toggleMapView();
            }
        }, 1000);
    </script>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_s4sQ4Cp6-NYlUQ6Lsyk4W5ePX9mtiYM&libraries=visualization&callback=initMap">
    </script>
</body>
</html>