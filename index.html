<!DOCTYPE html>
<html lang="es-mx">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGP - INICIO</title>
    <link rel="stylesheet" href="frontend/styles/output.css">
    <style>
        /* Eliminar fondo blanco de los InfoWindows de Google Maps */
        .gm-style-iw {
            background: transparent !important;
            padding: 0 !important;
        }
        
        .gm-style-iw-d {
            background: transparent !important;
            padding: 0 !important;
            overflow: visible !important;
        }
        
        .gm-style-iw-c {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
        }
        
        /* Eliminar el bot칩n de cerrar blanco si es necesario */
        .gm-ui-hover-effect {
            opacity: 0.8;
        }
        
        .gm-ui-hover-effect:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-950 flex flex-col min-h-screen">
    <div id="header-container" class="w-full"></div>
    <main class="w-full h-auto py-4 sm:py-6 md:py-10 flex-1">
        <div class="w-full h-full flex flex-col items-center justify-center">
            <!-- Vista para usuarios NO autenticados: mapa completo -->
            <div id="map-container-public" class="w-full px-4 sm:px-6 md:w-4/5 h-full flex flex-col items-center justify-center">
                <div id="map" class="rounded-lg md:rounded-2xl w-full h-[300px] sm:h-[400px] md:h-[500px] lg:h-[600px] border border-slate-600"></div>
            </div>
            
            <!-- Vista para usuarios autenticados: mapa flex-1 + filtros flex-1 -->
            <div id="map-container-authenticated" class="w-full px-4 sm:px-6 md:w-4/5 flex flex-col md:flex-row items-start md:items-center justify-center gap-4 min-h-[500px] md:h-[600px] md:min-h-[600px] hidden">
                <!-- Mapa flex-1 -->
                <div class="w-full md:w-3/5 flex flex-col items-center justify-center min-h-[300px] sm:min-h-[400px] md:h-full md:min-h-[600px]">
                    <div id="map-authenticated" class="rounded-lg md:rounded-2xl w-full h-[300px] sm:h-[400px] md:h-full md:min-h-[600px] border border-slate-600"></div>
                </div>
                
                <!-- Filtros flex-1 -->
                <div class="w-full md:w-2/5 h-auto md:h-full md:min-h-[600px] flex flex-col items-start justify-center md:justify-center gap-3 py-4 md:py-6">
                    <!-- Selector de Zona -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="zona-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Zona:</label>
                        <div class="relative w-full">
                            <select id="zona-select" name="zona" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" disabled selected>Selecciona zona</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Grado de Peligrosidad -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="peligrosidad-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Grado de peligrosidad:</label>
                        <div class="relative w-full">
                            <select id="peligrosidad-select" name="peligrosidad" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" disabled selected>Selecciona la peligrosidad</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Delito -->
                    <div class="w-full h-auto flex flex-col items-start justify-center">
                        <label for="delito-select" class="w-full text-left text-sm md:text-base text-white mb-1 opacity-70">Delito:</label>
                        <div class="relative w-full">
                            <select id="delito-select" name="delito" class="w-full h-[45px] md:h-[50px] rounded-lg bg-white text-slate-950 py-3 md:py-4 px-3 md:px-4 pr-10 outline-0 focus:outline-2 focus:outline-blue-600 transition-all duration-300 text-sm md:text-base appearance-none opacity-70">
                                <option value="" disabled selected>Selecciona el delito</option>
                            </select>
                            <div class="absolute right-3 md:right-4 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-slate-950 opacity-70">
                                    <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot칩n Activar mapa de calor -->
                    <div class="w-full h-auto flex flex-col items-center justify-center mt-2">
                        <button type="button" id="heatmap-btn" class="w-full h-[45px] md:h-[50px] rounded-lg bg-blue-400 text-white text-base md:text-lg font-medium flex items-center justify-center hover:bg-blue-600 transition-all duration-150 hover:cursor-pointer">Activar mapa de calor</button>
                    </div>
                </div>
            </div>
    </main>
    <div id="footer-container"></div>
    <div id="modal-container"></div>
    <script src="frontend/javascript/app.js"></script>
    <script src="frontend/javascript/auth.js"></script>
    <script src="frontend/javascript/modals.js"></script>
    <script src="frontend/javascript/nuevo_usuario.js"></script>
    <script>
        let map;
        let mapAuthenticated;
        let currentInfoWindow = null;
        let allMarkers = [];
        let currentMarkers = [];
        let zonePolygons = {};
        let currentZonePolygon = null;
        let heatmapLayer = null;
        let heatmapActive = false;
        
        // Coordenadas detalladas de las zonas de San Luis Potos칤
        // Basadas en la plantilla mejorada (plantilla3.html)
        // IMPORTANTE:
        // Los IDs deben coincidir con los de la tabla "zonas" del backend:
        //  1: Norte
        //  2: Sur
        //  3: Oriente
        //  4: Poniente
        //  5: Centro
        const zoneCoordinates = {
            1: { // Norte
                name: "Norte",
                // Color tomado de la plantilla mejorada (id 2 - Norte)
                color: "#00AAFF",
                path: [
                    { lat: 22.1980806, lng: -101.0191069 },
                    { lat: 22.2044778, lng: -101.0160550 },
                    { lat: 22.2185265, lng: -100.9724515 },
                    { lat: 22.2131050, lng: -100.9327801 },
                    { lat: 22.2054055, lng: -100.9222381 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1712311, lng: -100.9672749 },
                    { lat: 22.1732495, lng: -100.9708684 },
                    { lat: 22.170000, lng: -101.001667 }
                ]
            },
            2: { // Sur
                name: "Sur",
                // Color tomado de la plantilla (id 3 - Sur)
                color: "#FF9900",
                path: [
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1281250, lng: -100.9758834 },
                    { lat: 22.1390283, lng: -101.0016146 },
                    { lat: 22.1259710, lng: -101.0171827 },
                    { lat: 22.1155634, lng: -100.9999287 },
                    { lat: 22.1170518, lng: -100.9969650 },
                    { lat: 22.1152539, lng: -100.9858002 },
                    { lat: 22.1009685, lng: -100.9524824 }
                ]
            },
            3: { // Oriente / Este
                name: "Oriente",
                // Color tomado de la plantilla (id 4 - Oriente / Este)
                color: "#00CC00",
                path: [
                    { lat: 22.2054055, lng: -100.9222381 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1009685, lng: -100.9524824 },
                    { lat: 22.1152030, lng: -100.9263403 },
                    { lat: 22.1258643, lng: -100.9192584 },
                    { lat: 22.1543387, lng: -100.9143996 }
                ]
            },
            4: { // Poniente / Oeste
                name: "Poniente",
                // Color tomado de la plantilla (id 5 - Poniente / Oeste)
                color: "#AA00FF",
                path: [
                    { lat: 22.1980806, lng: -101.0191069 },
                    { lat: 22.170000, lng: -101.001667 },
                    { lat: 22.1390283, lng: -101.0016146 },
                    { lat: 22.1259710, lng: -101.0171827 },
                    { lat: 22.1322477, lng: -101.0338589 },
                    { lat: 22.1515664, lng: -101.0337646 },
                    { lat: 22.1721585, lng: -101.0400926 },
                    { lat: 22.1862328, lng: -101.0328764 }
                ]
            },
            5: { // Centro (Casco Hist칩rico)
                name: "Centro",
                // Color tomado de la plantilla (id 1 - Centro)
                color: "#FF0000",
                path: [
                    { lat: 22.170000, lng: -101.001667 },
                    { lat: 22.1732495, lng: -100.9708684 },
                    { lat: 22.1712311, lng: -100.9672749 },
                    { lat: 22.1691838, lng: -100.9570286 },
                    { lat: 22.1359707, lng: -100.9563152 },
                    { lat: 22.1281250, lng: -100.9758834 },
                    { lat: 22.1390283, lng: -101.0016146 }
                ]
            },
        };

        // Funci칩n para cargar zonas en el selector
        async function loadZones() {
            try {
                const response = await fetch("http://localhost:8000/api/zones/");
                if (!response.ok) throw new Error("Error al cargar zonas");
                const zones = await response.json();
                
                const zonaSelect = document.getElementById("zona-select");
                if (!zonaSelect) return;
                
                // Limpiar opciones existentes
                zonaSelect.innerHTML = '';
                
                // Agregar opci칩n "Todas las zonas"
                const allOption = document.createElement("option");
                allOption.value = "";
                allOption.textContent = "Todas las zonas";
                allOption.selected = true;
                zonaSelect.appendChild(allOption);
                
                // Agregar zonas
                zones.forEach(zone => {
                    const option = document.createElement("option");
                    option.value = zone.id;
                    option.textContent = zone.nombre;
                    zonaSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar zonas:", error);
            }
        }

        // Funci칩n para cargar delitos en el selector
        async function loadCrimes() {
            try {
                const response = await fetch("http://localhost:8000/api/crimes/");
                if (!response.ok) throw new Error("Error al cargar delitos");
                const crimes = await response.json();
                
                const delitoSelect = document.getElementById("delito-select");
                if (!delitoSelect) return;
                
                // Limpiar opciones existentes
                delitoSelect.innerHTML = '<option value="" disabled selected>Selecciona el delito</option>';
                
                // Agregar delitos
                crimes.forEach(crime => {
                    const option = document.createElement("option");
                    option.value = crime.id;
                    option.textContent = crime.nombre;
                    delitoSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar delitos:", error);
            }
        }

        // Funci칩n para cargar niveles de peligrosidad en el selector
        function loadPeligrosidad() {
            // Solo 3 niveles: Bajo, Medio, Alto (strings)
            const peligrosidadLevels = [
                { nombre: 'Bajo', valor: 'Bajo' },
                { nombre: 'Medio', valor: 'Medio' },
                { nombre: 'Alto', valor: 'Alto' }
            ];
            
            const peligrosidadSelect = document.getElementById("peligrosidad-select");
            if (!peligrosidadSelect) return;
            
            // Limpiar opciones existentes
            peligrosidadSelect.innerHTML = '<option value="" disabled selected>Selecciona la peligrosidad</option>';
            
            // Agregar opci칩n "Todas"
            const todasOption = document.createElement("option");
            todasOption.value = "";
            todasOption.textContent = "Todas";
            peligrosidadSelect.appendChild(todasOption);
            
            // Agregar niveles de peligrosidad
            peligrosidadLevels.forEach(level => {
                const option = document.createElement("option");
                option.value = level.valor; // Usar el string: "Bajo", "Medio", "Alto"
                option.textContent = level.nombre;
                peligrosidadSelect.appendChild(option);
            });
        }

        // Funci칩n para dibujar pol칤gono de zona y hacer zoom a la zona seleccionada
        function drawZonePolygon(mapInstance, zoneId) {
            // Eliminar pol칤gono anterior si existe
            if (currentZonePolygon) {
                currentZonePolygon.setMap(null);
                currentZonePolygon = null;
            }
            
            // Si no hay zona seleccionada ("Todas las zonas"), limpiar pol칤gono
            // y restablecer el zoom/centro iniciales
            if (!zoneId || zoneId === '') {
                if (mapInstance) {
                    mapInstance.setCenter({ lat: 22.152089, lng: -100.973302 });
                    mapInstance.setZoom(12);
                }
                return;
            }
            
            const zone = zoneCoordinates[parseInt(zoneId)];
            if (!zone) return;
            
            // Crear pol칤gono para la zona
            currentZonePolygon = new google.maps.Polygon({
                paths: zone.path,
                strokeColor: zone.color || '#3B82F6',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: zone.color || '#3B82F6',
                fillOpacity: 0.2
            });
            
            currentZonePolygon.setMap(mapInstance);

            // Calcular bounds para la zona y ajustar el zoom
            const bounds = new google.maps.LatLngBounds();
            zone.path.forEach(coord => bounds.extend(coord));
            mapInstance.fitBounds(bounds);

            // Limitar el zoom m치ximo para que no se acerque demasiado
            google.maps.event.addListenerOnce(mapInstance, 'bounds_changed', function () {
                if (mapInstance.getZoom() > 14) {
                    mapInstance.setZoom(14);
                }
            });
        }
        
        // Funci칩n global para recargar marcadores (disponible desde otros scripts)
        window.reloadMapMarkers = function() {
            console.log('游댃 Recargando marcadores del mapa...');
            if (mapAuthenticated) {
                console.log('Recargando mapa autenticado...');
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                
                const selectedZona = zonaSelect && zonaSelect.value ? zonaSelect.value : null;
                const selectedPeligrosidad = peligrosidadSelect && peligrosidadSelect.value ? peligrosidadSelect.value : null;
                
                loadMarkers(mapAuthenticated, selectedZona, selectedPeligrosidad);
            }
            if (map) {
                console.log('Recargando mapa p칰blico...');
                loadMarkers(map, null, null);
            }
        };
        
        // Funci칩n para cargar marcadores en el mapa
        function loadMarkers(mapInstance, filterZona = null, filterPeligrosidad = null) {
            // Limpiar marcadores anteriores
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            // Si el heatmap est치 activo, actualizarlo
            if (heatmapActive && heatmapLayer) {
                heatmapLayer.setMap(null);
                heatmapLayer = null;
                heatmapActive = false;
                const heatmapBtn = document.getElementById("heatmap-btn");
                if (heatmapBtn) {
                    heatmapBtn.textContent = "Activar mapa de calor";
                    heatmapBtn.classList.remove("bg-red-400", "hover:bg-red-600");
                    heatmapBtn.classList.add("bg-blue-400", "hover:bg-blue-600");
                }
            }
            
            // Dibujar pol칤gono de la zona seleccionada
            drawZonePolygon(mapInstance, filterZona);
            
            fetch("http://localhost:8000/api/addresses/")
                .then(r => {
                    if (!r.ok) throw new Error("Error en la respuesta del servidor");
                    return r.json();
                })
                .then(data => {
                    const bounds = new google.maps.LatLngBounds();
                    let hasMarkers = false;

                    data.forEach(item => {
                        // Filtrar por zona si se especifica
                        if (filterZona !== null && filterZona !== '' && item.id_zona !== parseInt(filterZona)) {
                            return;
                        }
                        
                        // Filtrar por peligrosidad si se especifica
                        if (filterPeligrosidad !== null && filterPeligrosidad !== '') {
                            const itemPeligro = (item.grado_peligro || '').toString().trim();
                            if (itemPeligro.toLowerCase() !== filterPeligrosidad.toLowerCase()) {
                                return;
                            }
                        }
                        
                        if (item.lat && item.lng) {
                            const position = {
                                lat: parseFloat(item.lat),
                                lng: parseFloat(item.lng)
                            };

                            // Determinar color del marcador seg칰n peligrosidad
                            // peligrosidad es VARCHAR: "Bajo", "Medio", "Alto"
                            const peligro = (item.grado_peligro || '').toString().trim();
                            console.log(`游댌 Pandilla: ${item.nombre_pandilla || item.nombre}, grado_peligro: "${peligro}"`);
                            let markerColor = '#EF4444'; // Rojo por defecto (tailwind red-500)
                            let markerBorder = '#DC2626'; // Rojo m치s oscuro para el borde
                            if (peligro.toLowerCase() === 'bajo') {
                                markerColor = '#22C55E'; // Verde (tailwind green-500) - Bajo
                                markerBorder = '#16A34A'; // Verde m치s oscuro
                            } else if (peligro.toLowerCase() === 'medio') {
                                markerColor = '#EAB308'; // Amarillo (tailwind yellow-500) - Medio
                                markerBorder = '#CA8A04'; // Amarillo m치s oscuro
                            } else if (peligro.toLowerCase() === 'alto') {
                                markerColor = '#EF4444'; // Rojo (tailwind red-500) - Alto
                                markerBorder = '#DC2626'; // Rojo m치s oscuro
                            }

                            // Crear icono SVG personalizado sin fondo blanco
                            const filterId = `shadow-${item.id_pandilla || item.id || Math.random().toString(36).substr(2, 9)}`;
                            const iconSvg = `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg" style="background:transparent;"><defs><filter id="${filterId}" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/></filter></defs><path d="M16 0C7.163 0 0 7.163 0 16c0 10 16 24 16 24s16-14 16-24C32 7.163 24.837 0 16 0z" fill="${markerColor}" stroke="${markerBorder}" stroke-width="1.5" filter="url(#${filterId})"/><circle cx="16" cy="16" r="5" fill="#FFFFFF" opacity="0.95"/></svg>`;
                            
                            const iconUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(iconSvg)));

                            const marker = new google.maps.Marker({
                                position,
                                map: mapInstance,
                                title: item.nombre_pandilla || item.nombre || "Ubicaci칩n",
                                icon: {
                                    url: iconUrl,
                                    scaledSize: new google.maps.Size(32, 40),
                                    anchor: new google.maps.Point(16, 40),
                                    optimized: false
                                },
                                optimized: false
                            });

                            // Guardar informaci칩n adicional en el marcador para el heatmap
                            // Convertir string a n칰mero para el peso: Bajo=1, Medio=2, Alto=3
                            let pesoHeatmap = 1;
                            if (peligro.toLowerCase() === 'bajo') {
                                pesoHeatmap = 1;
                            } else if (peligro.toLowerCase() === 'medio') {
                                pesoHeatmap = 2;
                            } else if (peligro.toLowerCase() === 'alto') {
                                pesoHeatmap = 3;
                            }
                            marker.peligrosidad = pesoHeatmap;

                            // Calcular nivel de peligrosidad para el InfoWindow
                            let nivelTexto = peligro || 'Alto';
                            let nivelColor = '#EF4444';
                            if (peligro.toLowerCase() === 'bajo') {
                                nivelTexto = 'Bajo';
                                nivelColor = '#22C55E';
                            } else if (peligro.toLowerCase() === 'medio') {
                                nivelTexto = 'Medio';
                                nivelColor = '#EAB308';
                            } else if (peligro.toLowerCase() === 'alto') {
                                nivelTexto = 'Alto';
                                nivelColor = '#EF4444';
                            }

                            // InfoWindow con dise침o mejorado y m치s grande (recuadro oscuro)
                            const infoContent = `
                                <div style="min-width: 300px; max-width: 400px; padding: 1.5rem; font-family: system-ui, -apple-system, sans-serif;">
                                    <div style="background: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%); border-radius: 0.75rem; border: 2px solid rgb(51, 65, 85);">
                                        <div style="padding: 1.25rem;">
                                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin-bottom: 0.75rem; line-height: 1.5;">
                                                ${item.nombre_pandilla || item.nombre || 'Ubicaci칩n sin nombre'}
                                            </h3>
                                            <div style="margin-bottom: 0.75rem;">
                                                <p style="color: #E2E8F0; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                                    <span style="color: #94A3B8; font-weight: 600;">Direcci칩n:</span> 
                                                    ${item.calle || item.direccion || 'No disponible'}
                                                    ${item.numero ? ' ' + item.numero : ''}
                                                </p>
                                                ${item.colonia ? `<p style="color: #E2E8F0; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                                    <span style="color: #94A3B8; font-weight: 600;">Colonia:</span> ${item.colonia}
                                                </p>` : ''}
                                                ${item.grado_peligro !== null && item.grado_peligro !== undefined ? `<p style="color: #E2E8F0; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                                    <span style="color: #94A3B8; font-weight: 600;">Peligrosidad:</span> 
                                                    <span style="color: ${nivelColor}; font-weight: 700;">${nivelTexto}</span>
                                                </p>` : ''}
                                            </div>
                                            <a href="https://www.google.com/maps?q=${position.lat},${position.lng}" 
                                               target="_blank" 
                                               style="display: inline-flex; align-items: center; gap: 0.5rem; color: #60A5FA; text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: color 0.2s;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                                </svg>
                                                Ver en Google Maps
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;

                            const infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });

                            marker.addListener("click", () => {
                                // Cerrar otros InfoWindows antes de abrir uno nuevo
                                if (currentInfoWindow) {
                                    currentInfoWindow.close();
                                }
                                infoWindow.open(mapInstance, marker);
                                currentInfoWindow = infoWindow;
                            });

                            currentMarkers.push(marker);
                            bounds.extend(position);
                            hasMarkers = true;
                        }
                    });

                    if (hasMarkers) {
                        // Si hay marcadores, ajustar el zoom
                        if (currentMarkers.length === 1) {
                            // Si solo hay un marcador, usar zoom m치s cercano
                            mapInstance.setCenter(bounds.getCenter());
                            mapInstance.setZoom(14);
                        } else {
                            // Si hay m칰ltiples marcadores, ajustar a los bounds
                            mapInstance.fitBounds(bounds);
                        }
                        console.log(`Marcadores cargados: ${currentMarkers.length}${filterZona ? ` (Zona: ${filterZona})` : ' (Todas las zonas)'}`);
                    } else {
                        // Si no hay marcadores, centrar en San Luis Potos칤
                        mapInstance.setCenter({ lat: 22.152089, lng: -100.973302 });
                        mapInstance.setZoom(12);
                        console.log('No se encontraron marcadores para la zona seleccionada');
                    }
                })
                .catch(err => console.error("Error al cargar marcadores:", err));
        }

        // Funci칩n para activar/desactivar mapa de calor
        function toggleHeatmap() {
            if (!mapAuthenticated) {
                console.error('Mapa autenticado no est치 inicializado');
                return;
            }

            const heatmapBtn = document.getElementById("heatmap-btn");
            if (!heatmapBtn) return;

            if (!heatmapActive) {
                // Activar mapa de calor
                // Obtener todos los puntos de los marcadores actuales
                const heatmapData = [];
                
                currentMarkers.forEach(marker => {
                    // Obtener el grado de peligro del marcador si est치 disponible
                    const peligro = marker.peligrosidad || 1;
                    // Usar el peso basado en peligrosidad: Bajo (1) = 1, Medio (2) = 2, Alto (3) = 3
                    heatmapData.push({
                        location: marker.getPosition(),
                        weight: peligro
                    });
                });

                // Si no hay marcadores, cargar todos los datos
                if (heatmapData.length === 0) {
                    fetch("http://localhost:8000/api/addresses/")
                        .then(r => {
                            if (!r.ok) throw new Error("Error al cargar datos para heatmap");
                            return r.json();
                        })
                        .then(data => {
                            data.forEach(item => {
                                if (item.lat && item.lng) {
                                    // Usar el peso basado en peligrosidad: Bajo (1) = 1, Medio (2) = 2, Alto (3) = 3
                                    const peligro = parseInt(item.grado_peligro) || 1;
                                    heatmapData.push({
                                        location: new google.maps.LatLng(
                                            parseFloat(item.lat),
                                            parseFloat(item.lng)
                                        ),
                                        weight: peligro
                                    });
                                }
                            });
                            createHeatmap(heatmapData);
                        })
                        .catch(err => console.error("Error al cargar datos para heatmap:", err));
                } else {
                    createHeatmap(heatmapData);
                }
            } else {
                // Desactivar mapa de calor
                if (heatmapLayer) {
                    heatmapLayer.setMap(null);
                    heatmapLayer = null;
                }
                heatmapActive = false;
                heatmapBtn.textContent = "Activar mapa de calor";
                heatmapBtn.classList.remove("bg-red-400", "hover:bg-red-600");
                heatmapBtn.classList.add("bg-blue-400", "hover:bg-blue-600");
            }
        }

        // Funci칩n para crear el mapa de calor
        function createHeatmap(heatmapData) {
            if (!mapAuthenticated || !google.maps.visualization) {
                console.error('Google Maps Visualization library no est치 disponible');
                return;
            }

            // Eliminar heatmap anterior si existe
            if (heatmapLayer) {
                heatmapLayer.setMap(null);
            }

            // Crear nuevo heatmap con gradiente: Verde (Bajo) -> Amarillo (Medio) -> Rojo (Alto)
            heatmapLayer = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: mapAuthenticated,
                radius: 50,
                opacity: 0.6,
                gradient: [
                    'rgba(34, 197, 94, 0)',      // Verde transparente (Bajo)
                    'rgba(34, 197, 94, 0.3)',   // Verde suave
                    'rgba(34, 197, 94, 0.6)',   // Verde medio
                    'rgba(234, 179, 8, 0.7)',   // Amarillo (Medio)
                    'rgba(234, 179, 8, 0.9)',   // Amarillo intenso
                    'rgba(239, 68, 68, 1)'       // Rojo (Alto)
                ]
            });

            heatmapActive = true;
            const heatmapBtn = document.getElementById("heatmap-btn");
            if (heatmapBtn) {
                heatmapBtn.textContent = "Desactivar mapa de calor";
                heatmapBtn.classList.remove("bg-blue-400", "hover:bg-blue-600");
                heatmapBtn.classList.add("bg-red-400", "hover:bg-red-600");
            }
        }

        // Funci칩n para verificar si un elemento est치 visible
        function isElementVisible(element) {
            if (!element) return false;
            const style = window.getComputedStyle(element);
            return style.display !== 'none' && style.visibility !== 'hidden' && !element.classList.contains('hidden');
        }

        // Funci칩n para inicializar mapa p칰blico
        function initPublicMap() {
            const mapElement = document.getElementById("map");
            if (!mapElement) return false;
            
            // Si ya est치 inicializado, solo hacer resize
            if (map) {
                setTimeout(() => {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter({ lat: 22.152089, lng: -100.973302 });
                }, 100);
                return true;
            }
            
            // Verificar que el elemento est칠 visible
            if (!isElementVisible(mapElement.closest('#map-container-public'))) {
                console.log('Mapa p칰blico no visible a칰n, esperando...');
                return false;
            }
            
            map = new google.maps.Map(mapElement, {
                center: { lat: 22.152089, lng: -100.973302 },
                zoom: 12
            });
            loadMarkers(map);
            
            // Forzar resize despu칠s de un momento (m칰ltiples veces para asegurar renderizado)
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 100);
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 300);
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 500);
            
            return true;
        }

        // Funci칩n para inicializar mapa autenticado
        function initAuthenticatedMap() {
            const mapElement = document.getElementById("map-authenticated");
            if (!mapElement) return false;
            
            // Si ya est치 inicializado, solo hacer resize
            if (mapAuthenticated) {
                setTimeout(() => {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                    mapAuthenticated.setCenter({ lat: 22.152089, lng: -100.973302 });
                }, 100);
                return true;
            }
            
            // Verificar que el elemento est칠 visible
            if (!isElementVisible(mapElement.closest('#map-container-authenticated'))) {
                console.log('Mapa autenticado no visible a칰n, esperando...');
                return false;
            }
            
            mapAuthenticated = new google.maps.Map(mapElement, {
                center: { lat: 22.152089, lng: -100.973302 },
                zoom: 12
            });
            loadMarkers(mapAuthenticated);
            
            // Cargar zonas, delitos y peligrosidad en los selectores
            loadZones();
            loadCrimes();
            loadPeligrosidad();
            
            // Agregar evento al bot칩n de mapa de calor
            setTimeout(() => {
                const heatmapBtn = document.getElementById("heatmap-btn");
                if (heatmapBtn) {
                    heatmapBtn.addEventListener("click", toggleHeatmap);
                }
            }, 500);
            
            // Funci칩n para manejar el cambio de zona
            function handleZonaChange() {
                if (!mapAuthenticated) return;
                
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                
                if (!zonaSelect) return;
                
                const selectedZona = zonaSelect.value ? zonaSelect.value : null;
                const selectedPeligrosidad = peligrosidadSelect && peligrosidadSelect.value ? peligrosidadSelect.value : null;
                
                console.log('Zona seleccionada:', selectedZona);
                console.log('Peligrosidad seleccionada:', selectedPeligrosidad);
                
                // Recargar marcadores con los filtros de zona y peligrosidad
                loadMarkers(mapAuthenticated, selectedZona, selectedPeligrosidad);
            }
            
            // Funci칩n para manejar el cambio de peligrosidad
            function handlePeligrosidadChange() {
                if (!mapAuthenticated) return;
                
                const zonaSelect = document.getElementById("zona-select");
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                
                if (!peligrosidadSelect) return;
                
                const selectedZona = zonaSelect && zonaSelect.value ? zonaSelect.value : null;
                const selectedPeligrosidad = peligrosidadSelect.value ? peligrosidadSelect.value : null;
                
                console.log('Zona seleccionada:', selectedZona);
                console.log('Peligrosidad seleccionada:', selectedPeligrosidad);
                
                // Recargar marcadores con los filtros de zona y peligrosidad
                loadMarkers(mapAuthenticated, selectedZona, selectedPeligrosidad);
            }
            
            // Esperar un momento para que los selectores se carguen y luego agregar los eventos
            setTimeout(() => {
                const zonaSelect = document.getElementById("zona-select");
                if (zonaSelect) {
                    // Agregar listener para el cambio de zona
                    zonaSelect.addEventListener("change", handleZonaChange);
                }
                
                const peligrosidadSelect = document.getElementById("peligrosidad-select");
                if (peligrosidadSelect) {
                    // Agregar listener para el cambio de peligrosidad
                    peligrosidadSelect.addEventListener("change", handlePeligrosidadChange);
                }
            }, 500);
            
            // Forzar resize despu칠s de un momento (m칰ltiples veces para asegurar renderizado)
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 100);
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 300);
            setTimeout(() => {
                if (mapAuthenticated) {
                    google.maps.event.trigger(mapAuthenticated, 'resize');
                }
            }, 500);
            
            return true;
        }

        // Funci칩n para mostrar/ocultar vistas seg칰n autenticaci칩n (disponible globalmente)
        window.toggleMapView = function() {
            const isAuth = typeof isAuthenticated === 'function' ? isAuthenticated() : false;
            const publicContainer = document.getElementById("map-container-public");
            const authenticatedContainer = document.getElementById("map-container-authenticated");

            if (isAuth) {
                // Usuario autenticado: mostrar vista con filtros
                if (publicContainer) publicContainer.classList.add("hidden");
                if (authenticatedContainer) authenticatedContainer.classList.remove("hidden");
                
                // Inicializar mapa autenticado si Google Maps est치 cargado
                if (typeof google !== 'undefined' && google.maps) {
                    // Esperar a que el contenedor sea visible y luego inicializar
                    const tryInit = () => {
                        if (initAuthenticatedMap()) {
                            console.log('Mapa autenticado inicializado correctamente');
                            // Forzar m칰ltiples resize para asegurar renderizado
                            setTimeout(() => {
                                if (mapAuthenticated) {
                                    google.maps.event.trigger(mapAuthenticated, 'resize');
                                }
                            }, 100);
                            setTimeout(() => {
                                if (mapAuthenticated) {
                                    google.maps.event.trigger(mapAuthenticated, 'resize');
                                }
                            }, 300);
                        } else {
                            // Reintentar despu칠s de un momento
                            setTimeout(tryInit, 200);
                        }
                    };
                    // Esperar un poco m치s para asegurar que el contenedor es visible
                    setTimeout(tryInit, 300);
                }
            } else {
                // Usuario no autenticado: mostrar vista p칰blica
                if (publicContainer) publicContainer.classList.remove("hidden");
                if (authenticatedContainer) authenticatedContainer.classList.add("hidden");
                
                // Inicializar mapa p칰blico si Google Maps est치 cargado
                if (typeof google !== 'undefined' && google.maps) {
                    // Esperar a que el contenedor sea visible y luego inicializar
                    const tryInit = () => {
                        if (initPublicMap()) {
                            console.log('Mapa p칰blico inicializado correctamente');
                            // Forzar m칰ltiples resize para asegurar renderizado
                            setTimeout(() => {
                                if (map) {
                                    google.maps.event.trigger(map, 'resize');
                                }
                            }, 100);
                            setTimeout(() => {
                                if (map) {
                                    google.maps.event.trigger(map, 'resize');
                                }
                            }, 300);
                        } else {
                            // Reintentar despu칠s de un momento
                            setTimeout(tryInit, 200);
                        }
                    };
                    setTimeout(tryInit, 100);
                }
            }
        }

        // Funci칩n principal de inicializaci칩n (callback de Google Maps)
        function initMap() {
            // Esperar a que el DOM est칠 completamente listo
            setTimeout(() => {
                // Verificar autenticaci칩n y mostrar la vista correcta
                toggleMapView();
            }, 300);
        }

        // Verificar autenticaci칩n cuando se carga la p치gina
        document.addEventListener('DOMContentLoaded', function() {
            // Si Google Maps ya est치 cargado, inicializar
            if (typeof google !== 'undefined' && google.maps) {
                // Si no hay mapa p칰blico, inicializarlo
                if (!map) {
                    initPublicMap();
                }
                // Luego verificar autenticaci칩n
                toggleMapView();
            }
        });

        // Tambi칠n verificar despu칠s de que se carguen los scripts de auth
        setTimeout(() => {
            if (typeof google !== 'undefined' && google.maps) {
                // Si no hay mapa p칰blico, inicializarlo
                if (!map) {
                    initPublicMap();
                }
                // Luego verificar autenticaci칩n
                toggleMapView();
            }
        }, 1000);
    </script>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_s4sQ4Cp6-NYlUQ6Lsyk4W5ePX9mtiYM&libraries=visualization&callback=initMap">
    </script>
</body>
</html>